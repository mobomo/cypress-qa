FROM stevenlafl/cypress-cucumber-lambda as base
FROM public.ecr.aws/lambda/nodejs:14

ENV npm_config_cache="/opt/nodejs/.npm"
ENV CYPRESS_CACHE_FOLDER="/opt/nodejs/.cache"
ENV LD_LIBRARY_PATH="$LAMBDA_TASK_ROOT/lib:$LAMBDA_TASK_ROOT/lib64:$LAMBDA_RUNTIME_DIR:$LAMBDA_RUNTIME_DIR/lib:$LAMBDA_TASK_ROOT:/opt/lib:/opt/lib64:/lib64:/usr/lib64"

COPY --from=base /opt/nodejs/.cache /opt/nodejs/.cache
COPY --from=base /opt/nodejs/.npm /opt/nodejs/.npm
COPY --from=base /opt/usr/bin/xvfb-run /opt/usr/bin/xvfb-run

COPY src/layer/nodejs /var/task

RUN npm run test:prod

ENTRYPOINT ["/bin/bash"]